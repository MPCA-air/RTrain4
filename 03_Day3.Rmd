---
title: "R Training | Day 3"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: readable
    highlight: tango
    css: css/camp_style.css
    number_sections: true
    self_contained: false
    fontsize: 18pt
    monofont: Source Code Pro
    monofontoptions: Scale = 1.4
---


```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
knitr::opts_chunk$set(fig.width = 11, fig.height = 6) 
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
library(tidyverse)
library(ggplot2)
```

# Welcome back Jedis! {-}
<hr>

![](images/day3_sq.png){width="260" style="float: left; margin-right: 60px; margin-top: 8px;"}

<br>


### Open your RStudio project {-}

- __Open__ your project folder from last week
- Double click the __.Rproj__ file to open RStudio

__Open a New script__

- __File > New File > R Script__

- Click the _floppy disk_ save icon
- Give it a name: `03_day.R` will work well



## Schedule  {-}

<div class="well">

- Review
- Working with <i class="fa fa-calendar" aria-hidden="true"></i> __dates__ - Endor Storm Chasing
- The magic __pipe__ `%>%`
- Where's Finn?
- Join 2 tables: `left_join` to the rescue
- Calculate summary stats for your __entire table__
- `group_by`: Calculate stats for each group and category (for each monitoring site, each pollutant, each year, or every thingymajig in your data)
- __Save__ __&__ __Export__ data

</div>   
    


## Porg review {-}

The _poggle_ of porgs has returned to help us review the `dplyr` functions. Follow along by downloading the __porg__ data from the URL below.

```{r, eval = F}
library(readr)
porgs <- read_csv("https://itep-r.netlify.com/data/porg_data.csv")
```

<br>

```{r porg-tabs, results='asis', echo=F}
cat(readLines("porg_tabs.txt"))
```

<br>



# New mission! {-}
<hr>

BB8 received new data from the wookies suggesting there was a large magnetic storm just before `Site 1` burned down on Endor. Sounds like we're going to be __STORM CHASERS__!


__Get the dataset__

While we're relaxing and flying to Endor let's get set up with our new data.

<br>

__Endor Setup__

1. Download the data.
    - <a href="https://itep-r.netlify.com/data/air_endor.csv"><span class="btn_code_blue" style="margin-bottom: 10px; margin-top: 12px;"> __DOWNLOAD__  </span></a> -  Get the Endor monitoring data
1. Create a new folder called `data` in your project folder.
1. Move the downloaded Endor file to there.
1. Create a new R script called `endor.R`

Now we can read in the data from the data folder with our favorite `read_csv` function.

```{r, endor-air-read, eval=F}
library(readr)
library(dplyr)
library(janitor)

air_endor <- read_csv("data/air_endor.csv")

names(air_endor)

# Clean the column names
air_endor <- clean_names(air_endor)

names(air_endor)
```

```{r, endor-air-read2, echo=F, message=F}
library(readr)
library(dplyr)
library(janitor)

air_endor <- read_csv("https://itep-r.netlify.com/data/air_endor.csv")

air_endor <- clean_names(air_endor)

names(air_endor)
```

<br>

<div class="tip">

### Note 

When your project is open, RStudio sets the working directory to your project folder. When reading files from a folder outside of your project, you'll need to use the full file path location. 

For example, for a file on the __X-drive__: `X://Programs/Air_Quality/Ozone_data.csv`
<br>

</div>


# Welcome to Endor! {-}

![](https://itep-r.netlify.com/images/planet_endor.jpg){style="width: 75%; margin-top: -4px; margin-left: 11%;"}

<br>

__Let's get acquainted with our new Endor data set.__ 

>
> Remember the different ways?
>
> _Hint:_ `summary()`, `glimpse()`, `nrow()`, `distinct()`
>

<br>


```{r, endor-air2}

glimpse(air_endor)
```

<br>
```{r, dis}
distinct(air_endor, analyte)
```
<br>

__Woah. There are definitely more analytes than we need. We only want to know about `magnetic_field` data. Let's filter down to only that analyte.__ 

<br>

```{r, endor-air-filter}

mag_endor <- filter(air_endor, analyte == "magnetic_field")
```

<br>

__Boom!__ How many rows are left now?


<br>


__How do we filter on the date column?__

<br>

<div class="well">
With time series data it's helpful for R to know which columns are __date__ columns. Dates come in many formats and the standard format in R is `2019-01-15`, also referred to as _Year-Month-Day_ format.

We use the `lubridate` package to help format our dates.
</div>


# | <i class="fa fa-calendar" aria-hidden="true"></i> Dates 
<hr>

### The `lubridate` package {-}

![](images/lubridate.png){style="width: 21%; float: left; margin-right: 30px; margin-top: 8px; margin-bottom: 12px;"}


<br>

It's about time! Lubridate makes working with dates much easier. 

We can find how much time has elapsed, add or subtract days, and find seasonal and day of the week averages. 

<br>

<div style="clear: both;"></div>

<br>

### Convert text to a *DATE* {-}

| Function    |  Order of date elements                                 |   
|----|:-----------------------------------------------------------------|  
|`mdy()  `    | Month-Day-Year :: `05-18-2019` or `05/18/2019`                 |  
|`dmy()  `    | Day-Month-Year (Euro dates) :: `18-05-2019` or `18/05/2019`    |  
|`ymd()  `    | Year-Month-Day (science dates) :: `2019-05-18` or `2019/05/18` |  
|`ymd_hm() `  | Year-Month-Day Hour:Minutes ::  `2019-05-18 8:35 AM`          |  
|`ymd_hms() ` | Year-Month-Day Hour:Minutes:Seconds ::  `2019-05-18 8:35:22 AM`    | 

<br>

### Get date parts {-}

| Function   |  Date element                                            |   
|----|:-----------------------------------------------------------------|  
|`year()  `  | Year          |  
|`month()`   | Month as _1,2,3_; For _Jan, Feb, Mar_ use `label=TRUE`  |  
|`day()`     | Day of the month  |  
|`wday()`    | Day of the week as _1,2,3_; For _Sun, Mon, Tue_ use `label=TRUE` |  
| _- Time -_   |            | 
|`hour() `   |  Hour of the day _(24hr)_ |  
|`minute() ` |  Minutes   |  
|`second() ` |  Seconds   |  
|`tz()  `    |  Time zone |  


<br>


## Install `lubridate` {-}

First, type or copy and paste `install.packages("lubridate")` into RStudio.

## <i class="fa fa-broom" aria-hidden="true"></i> Clean the dates {-}

Let's use the `mdy()` function to turn the `start_run_date` column into a nicely formatted date.

```{r endor-air-mutate, message=F}
library(lubridate)

mag_endor <- mutate(mag_endor, date = mdy(start_run_date),
                               year = year(date))
```


<br>

__According to the request we received, the Resistance is only interested in observations from the year `2017`. So let's filter the data down to only dates within that year.__ 

<br>

```{r endor-air-filter-year}
mag_endor <- filter(mag_endor, year == "2017")
```


## Time series {-}
```{r endor-time, message=F}
ggplot(mag_endor, aes(x = date, y = result)) + 
  geom_line(size = 2, color = "tomato") + 
  geom_point(size = 5, alpha = 0.5)  # alpha changes transparency

```

Looks like the measurements definitely picked up a signal towards the end of the year. Let's make a different chart to show when this occurred. 

<br>


<div class="note">
### Mission complete! {-}

Aha! There really was a spike in the magnetic field in November. Hopefully, the _Resistance_ will reward us handsomely for this information.

</div>



# | The pipe operator

>
> **I wish I could type the name of the data frame less often. **
>

<br>

![](images/pipe.png){style="margin-right: 20px; width: 136px; float: left;"}


__Now you can!__ 

We use the `%>%` to chain functions together and make our scripts more streamlined. We call it the _pipe_.

<br>

<div style="clear: both;"></div>

Here are 2 examples of how the `%>%` operator is helpful. 

<br>

__`#1:`__ It eliminates the need for nested parentheses. 

Say you wanted to take the sum of 3 numbers and then take the log and then round the final result.
```{r maths, eval=F}
round(log(sum(c(10,20,30,40))))

```

<br>

The code doesn't look much like the words we used to describe it. Let's pipe it so we can read the code from left to right.
```{r maths_better, eval = F}
c(10,20,30,50) %>% sum() %>% log10() %>% round()
```

<br>

__`#2:`__ We can combine many processing steps into one cohesive chunk.

<br>

Here are some of the functions we've applied to the scrap data so far:

```{r review, eval=F}

scrap <- arrange(scrap, desc(price_per_pound))

scrap <- filter(scrap, origin != "All")

scrap <- mutate(scrap, 
                scrap_finder    = "BB8",
                measure_method  = "REM-24")
```

<br>


We can use the `%>%` operator and write it this way.

```{r review-better, eval=F}

scrap <- scrap %>%
           arrange(desc(price_per_pound)) %>%
           filter(origin != "All") %>%
           mutate(scrap_finder    = "BB8",
                  measure_method  = "REM-24")

```

<br>

<div class="tip">

### <i class="fa fa-bicycle" aria-hidden="true" style="color: green"></i> EXERCISE {-}

Similar to above, use the `%>%` to combine the two Endor lines below.

```{r better_endor, eval=F}
# Filter to only magnetic_field measurements
mag_endor <- filter(air_endor, analyte == "magnetic_field")

# Add a date column to the filtered data
mag_endor <- mutate(mag_endor, date = mdy(start_run_date))

```

</div>

<br>



>
> __So where were we?__ 
>
> __Oh right, we we're enjoying our time on beautiful lush Endor. Aren't we missing somebody...?__
>


# | Finn needs us! {-}

That's enough _scuttlebutting_ around on Endor, Finn needs us back on Jakku. It turns out we forgot to pick-up Finn when we left. Now he's being held ransom by Junk Boss Plutt. We'll need to act fast to get to him before the Empire does. __Blast off!__ 

<br>

![](images/finn_run.gif){style="margin-left: 18%; width: 60%; margin-top: 6px;"}

<br>


# More data {-}

<div class="tip"> 
<h3 style="margin-top: 13px;"> Update from BB8! </h3>

BB8 was busy on our flight back to Jakku, and was able to recover a __full__ set of scrap records from the notorious Unkar Plutt. Let's take a look.


```{r full-scrap, eval=T, echo=T}
library(readr)
library(dplyr)

# Read in the full scrap database
scrap <- read_csv("https://itep-r.netlify.com/data/starwars_scrap_jakku_full.csv")
```
</div>

<br>

# | Jakku re-visited
<hr>

Okay, so we're back on this ol' dust bucket. Let's try not to forget anything this time. We're quickly running out of friends on this planet.

## A scrappy ransom {-}

Mr. Baddy Plutt is demanding __10,000 items__ of scrap for Finn. Sounds expensive, but lucky for us he didn't clarify the exact items. Let's find the scrap that weighs the least per shipment and try to make this transaction as light as possible. 

Take a look at our __NEW__ scrap data and see if we have the weight of all the items.

```{r fullscrap-units, eval=T}
# What unit types are in the data?
unique(scrap$units)
```

<br>

__Or return results as a data frame__
```{r distinct-units, eval=T}
distinct(scrap, units)
```

<br>


_Hmmm...._ So how much does a cubic yard of `Hull Panel` weigh? 

_A lot? 32? Maybe..._ 

I think we're going to need some more data. 

<br>

<div class="tip">
<br>

__"Hey BB8!"__ 

__"Do your magic data finding thing."__

</div>


## Weight conversion {-}

![](images/rey_bb8.jpg){align="right" style="width: 35%; margin-top: 0px; margin-left: 15px; margin-right: 0px;"}

It took a while, but with a few droid bribes BB8 was able to track down a _Weight conversion table_ from his old droid buddies. Our current data shows the total cubic yards for some scrap shipments, but not how much the shipment weighs. 

### Read the weight conversion table {-}
```{r read-convert, eval = T, message = F}
# The data's URL
convert_url <- "https://rtrain.netlify.com/data/conversion_table.csv"

# Read the conversion data
convert <- read_csv(convert_url)

head(convert, 3)
```

<br>

Stars! A cubic yard of `Hull Panel` weighs __641 lbs__. That's what I thought!

Let's join this new conversion table to the scrap data to make our calculations easier. To do that we need to make a new friend.

__Say "Hello" to `left_join()`!__  


# | Join tables
<hr>

![](images/leftjoin_scrap.png){style="width: 55%; margin-left: 18%;"}

<br><br><br>


`left_join()` works like a zipper and combines two tables based on one or more variables. It's called "left"-join because the entire table on the left side is retained. Anything that matches from the right table gets to join the party, but the rest will be ignored.


## Join 2 tables {-}

### `left_join(table1, table2, by = c("columns to join by"))` {-}

<br>


### Adding porg names {-}

Remember our porg friends? How rude of us not to share their names. __Wups!__

Here they are:

<div style="margin-left: 10px; margin-top: 24px; width: 37%; margin-bottom: 34px;">
![](images/porgs/porg_names_tbl.png)
</div>

<div style="clear: both;"></div>

__Hey now!__ That's not very helpful. Who's who? Let's join their names to the rest their data.

<br>


![](images/porgs/porg_join.png){style="width: 85%;"}

<br>

### __The result__ {-}

<div class="well">
![](images/porgs/porgs_and_names.png){style="width: 85%; max-width: 85%;"}
</div>

<br>

## Back to scrap land{-}

Let's apply our new `left_join()` skills to the scrap data.

<br>

### Join the conversion table to the scrap {-}

Look at the tables. What columns in both tables do we want to join __by__?


<br>

```{r join-convert, eval=T}
scrap <- left_join(scrap, convert, 
                   by = c("item" = "item", "units" = "units"))
```

<br>

> Want to skimp on typing?

<br>

When the 2 tables share column names that are the same, `left_join()` will automatically search for matching columns. Nice! So the code below does the same as above.

```{r join-convert2, eval=F}
scrap <- left_join(scrap, convert)

head(scrap, 4)
```

```{r join-convert3, eval=T, echo=F}
head(scrap, 4)
```

<br>

__Want more details?__ 

You can type `?left_join` to see all the arguments and options.

<br>

## Total pounds per shipment {-}

Let's `mutate()`! 

Now that we have pounds per unit we can use `mutate` to calculate the total pounds for each shipment.

<br>

```{r, echo=F}
scrap <- scrap %>% 
         mutate(total_pounds = amount * pounds_per_unit)
         
```

__Fill in the blank__
```{r, eval=F}
scrap <- scrap %>% 
         mutate(total_pounds = amount *  _____________ )
         
```

<details>
<summary class = "btn_code">_Show code_</summary>
<p>
```{r}
scrap <- scrap %>% 
         mutate(total_pounds = amount * pounds_per_unit)
         
```
</p></details>


## Total price per shipment {-}

<div class="tip">

### <i class="fa fa-bicycle" aria-hidden="true" style="color: green"></i> EXERCISE {-}

```{r exer-tabs, results='asis', echo=F}
source("insert_tabs.R")

tabs <- c("Total price", "Show hint", "Show code")

content <- c(Exercise = "<h4> Total price </h4>

We need to do some serious multiplication. We now have the total amount shipped in pounds, and the price per pound, but we want to know the total price for each transaction. 

How do we calculate that? 

code_start
# Calculate the total price for each shipment
scrap <- scrap %>% 
         mutate(credits = ________ * ________ )
         
code_end",

show_hint = '<h4> Total price </h4>

We need to do some serious multiplication. We now have the total amount shipped in pounds, and the price per pound, but we want to know the total price for each transaction. 

How do we calculate that?

code_start
# Calculate the total price for each shipment
scrap <- scrap %>% 
         mutate(credits = total_pounds  * ________ )

code_end',

show_code = '<h4> Total price </h4>

We need to do some serious multiplication. We now have the total amount shipped in pounds, and the price per pound, but we want to know the total price for each transaction. 

How do we calculate that?

code_start
# Calculate the total price for each shipment
scrap <- scrap %>% 
         mutate(credits = total_pounds * price_per_pound)
         
code_end')

tab_html <- add_tabs(tabs, content)

cat(paste0(tab_html, collapse = "\n"))
```

</div>

<br>

```{r, echo=F}
# Calculate the total price for each shipment
scrap <- scrap %>% 
         mutate(credits = total_pounds * price_per_pound)
```


## Price per item {-}

__Great!__ Let's add one last column. We can divide the shipment's _credits_ by the _amount_ of items to get the `price_per_unit`.

```{r}
# Calculate the price per unit
scrap <- scrap %>% 
         mutate(price_per_unit = credits / amount)
```

<br>

<div class="note" style="line-height: 1.6;">

Data analysts often get asked summary questions such as:

- What's the highest or worst? 
- What's the lowest number? 
- Is that worse than average?
    - What's the average tonnage of scrap from Cratertown this year? 
- What city is making the most money?

</div>


### On to `summarize()`! {-}


# | `summarize()` this!
<hr>

![](images/summarize_diagram.png){width="500"}

`summarize()` allows you to apply a summary function like `median()` to a column and collapse your data down to a single row. To really dig into `summarize` you'll want to know some common summary functions, such as `sum()`, `mean()`, `median()`, `min()`, and `max()`.



## `sum()` {-}

Use `summarize()` and `sum()` to find the total credits of __all__ the scrap.

```{r, eval=F}
summarize(scrap, total_credits = sum(credits))
```


## `mean()` {-}
Use `summarize()` and `mean()` to calculate the _mean_ `price_per_pound` in the scrap report.

```{r, eval=F}
summarize(scrap, mean_price = mean(price_per_pound, na.rm = T))
```

<br>

<div class="tip">

<br>

__Note__ the `na.rm = TRUE` in the `mean()` function. This tells R to ignore empty cells or missing values that show up in R as `NA`. If you leave `na.rm` out, the _mean_ function will return 'NA' if it finds a missing value in the data.

</div>

## `median()` {-}
Use summarize to calculate the _median_ price_per_pound in the scrap report.

```{r, eval=F}
summarize(scrap, median_price = median(price_per_pound, na.rm = T))
```

## `max()` {-}
Use summarize to calculate the _maximum_ price per pound any scrapper got for their scrap.

```{r, eval=F}
summarize(scrap, max_price = max(price_per_pound, na.rm = T))
```

## `min()` {-}
Use summarize to calculate the _minimum_ price per pound any scrapper got for their scrap.

```{r, eval=F}
summarize(scrap, min_price = min(price_per_pound, na.rm = T))
```

## `nth()` {-}
Use `summarize()` and `nth(Origin, 12)` to find the name of the Origin City that had the  _12th_ highest scrapper haul.   

_Hint: Use `arrange()` first._

```{r, eval=F}
arrange(scrap, desc(credits)) %>% summarize(price_12 = nth(origin, 12))
```


## `quantile()` {-}

Quantiles are great for finding the upper or lower range of a column. Use the `quantile()` function to find the the 5th and 95th quantile of the prices.

```{r quants, eval=F}

summarize(scrap, 
          price_5th_pctile  = quantile(price_per_pound, 0.05, na.rm = T),
          price_95th_pctile = quantile(price_per_pound, 0.95))
```


__Hint:__ Add `na.rm = T` to `quantile()`.

<br>

<div class="tip">

### <i class="fa fa-bicycle" aria-hidden="true" style="color: green"></i> EXERCISE {-}

Create a summary of the scrap data that includes 3 of the summary functions above. The following is one example.

```{r, eval = F}
summary <- scrap %>% 
             summarize(max_credits      =  __________ ,
                       mean_credits     =  __________ ,
                       min_pounds       =  __________  )
                     
```

</div>

<br>


## `n()` {-}

`n()` stands for _count_. It has the smallest function name I know of, but is super useful.

Use summarize and `n()` to count the number of reported scrap records going to `Niima outpost`. 

<br>

__Hint:__ Use `filter()` first.

```{r, eval=F}
niima_scrap <- filter(scrap, destination == "Niima Outpost") 
```


```{r, eval=F}
niima_scrap <- summarize(niima_scrap, scrap_records = n())
```


<br>

Ok. That was fun. Now let's do a summary for Cratertown. And then for Blowback Town. And then for Tuanul. And then for...

<br>


### __Wait!__ {-}

> Do we really need to `filter` to the _origin_ city that we're interested in every single time? 
>
> How about you just give me the mean price for every _origin_ city. Then I could use that to answer a question about any city I want.
>
> Okay. Fine. It's time we talk about __`group_by()`.__ 
>


# | `group_by()`
<hr>

## The junk Capital of Jakku {-}

> Which origin city had the most shipments of junk?

<br>

Use `group_by` with the column _origin_, and then use`summarize` to count the __number__ of records at each origin city. 

<br>

__Fill in the blank__
```{r total-shipped, eval=F}

scrap_shipments <- group_by(scrap, ______ ) %>% 
                     summarize(shipments =  ______ ) 

```

<details>
<summary class = "btn_code">_Show code_</summary>
<p>
```{r count-ships, eval=F}

scrap_shipments <- group_by(scrap, origin ) %>% 
                     summarize(shipments =  n() ) 

```
</p></details>


<div class="quiz">
### Pop Quiz! {-}

__Which city had the most scrap shipments?__

<input type="radio"> _Tuanul_         <br> 
<input type="radio"> _Outskirts_      <br> 
<input type="radio"> _Reestki_        <br> 
<input type="radio"> _Cratertown_     <br> 
<br>

<details>
<summary class = "btn_code">_Show solution_</summary>

<p>
<i class="fa fa-check" aria-hidden="true" style="color: green;"></i> `Cratertown`  

_You've got the POWER!_

</p>
</details></div>


## Bargain hunters {-}

Who's selling goods for cheap? 

Use `group_by` with the column _origin_, and then use`summarize` to find the `mean(price_per_unit)` at each origin city. 


<details>
<summary class = "btn_code">_Show code_</summary>
<p>
```{r mean_price-by-origin, eval=F}

mean_prices <- group_by(scrap, origin) %>% 
                 summarize(mean_price = mean(price_per_unit, na.rm = T)) %>%
                 ungroup()

```
</p></details>

<br>


<details>
<summary class="btn_code_blue"> EXPLORE: Rounding digits </summary>

<div class="note" style="margin-top: -9px;">
<p>
You can round the prices to a certain number of digits using the `round()` function. We can finish by adding the `arrange()` function to sort the table by our new column.

```{r mean_price-by-Origin-round, eval = F}

mean_prices <- group_by(scrap, origin) %>% 
                 summarize(mean_price       = mean(price_per_unit, na.rm = T),
                           mean_price_round = round(mean_price, digits = 2)) %>%  
                 arrange(mean_price_round) %>%
                 ungroup()

```

<br>

</p>
</div>
</details>


<br>


<div class="well">
### <i class="fa fa-user-astronaut" aria-hidden="true" style="color:#040707;"></i> Pro-tip! {-}

Ending with `ungroup()` is good practice. This prevents your data from staying grouped after the summarizing has been completed.
</div>


# | Save files
<hr>

Let's save the mean price summary table we created to a _CSV_. That way we can transfer it to a _droid courier_ for delivery to Rey. To save a data frame we use the `write_csv()` function from our favorite `readr` package. 

```{r, eval=F}

# Write the file to your results folder
write_csv(mean_prices, "results/prices_by_origin.csv")

```

<br>

<div class="red-note">

##### <i class="fas fa-exclamation-triangle" style="color: #040707;"></i> __WARNING!__ {-}

By default, when saving files R will overwrite a file if the file already exists in the same folder. It will not ask for confirmation. To be safe, save processed data to a new folder called `results/` and not to your raw `data/` folder.

</div>


<br>

# <i class="fa fa-rocket" aria-hidden="true"></i> Return to [Homebase](index.html) {-}

<br>
